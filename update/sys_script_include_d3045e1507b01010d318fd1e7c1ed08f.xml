<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_417679_devtrack.devTrackServer</api_name>
        <caller_access/>
        <client_callable>true</client_callable>
        <description/>
        <name>devTrackServer</name>
        <script><![CDATA[var devTrackServer = Class.create();
devTrackServer.prototype = Object.extendsObject(global.AbstractAjaxProcessor, {
	
	setDevTesting : function(d, action, update) {
		if(d==null||action==null) throw '[devTrackServer.setDevTesting] parameter "d" or "action" is null';
		
		this.getTesters(d).forEach(function(user,i){
			if(action) this.addTester(d,user,true);
			else this.removeTester(d,user,true);
		});
		
		if(update==null || update==true) {
			var dev = new GlideRecord('x_417679_devtrack_development');
			if(dev.get(d)) {
				dev.feedback_state = action==true ? 'open' : 'closed';
				dev.update();
			}
		} else throw '[devTrackServer.setDevTesting] couldnt get development record '+d;
		
		var tasks = new GlideRecord('x_417679_devtrack_test');
		tasks.addQuery('development='+d+'^state=-5');
		tasks.setValue('active',true);
		tasks.setValue('state',gs.getProperty('x_417679_devtrack.default_test_task_open_state'));
		tasks.updateMultiple();
		return action;
	},
	
	isDevTesting : function(d) {
		var dev = new GlideRecord('x_417679_devtrack_development');
		if(!dev.get(d)) throw '[devTrackServer.isDevTesting] couldnt get development record '+d;
		return dev.feedback_state=='open' ? true : false;
	},
	
	getTesters : function(d) {
		var testers = [];
		var gr = new GlideRecord('x_417679_devtrack_testers');
		gr.addQuery('development='+d);
		gr.query();
		while(gr.next()) testers.push(gr.getValue('user'));
		return testers;
	},
	
	isTester : function(d, u) {
		var dev = d || this.getParameter('sysparm_dev');
		var user = u || this.getParameter('sysparm_user');
		
		var gr = new GlideRecord('x_417679_devtrack_testers');
		gr.addQuery('development='+dev+'^user='+user);
		gr.query();
		return gr.hasNext();
	},
	
	hasTested : function(d, u) {
		var dev = d || this.getParameter('sysparm_dev');
		var user = u || this.getParameter('sysparm_user');
		
		var gr = new GlideRecord('x_417679_devtrack_test');
		gr.addQuery('development='+dev+'^assigned_to='+user);
		gr.query();
		return gr.hasNext();
	},
	
	addTester : function(d, u, fromRL) {
		var dev = d || this.getParameter('sysparm_dev');
		var user = u || this.getParameter('sysparm_user');
		
		if(fromRL==null || fromRL==false) {
			var gr = new GlideRecord('x_417679_devtrack_testers');
			gr.addQuery('development='+dev+'^user='+user);
			gr.query();
			if(!gr.hasNext()) {
				gr.initialize();
				gr.development = dev;
				gr.user = user;
				gr.insert();
			}
		}
		
		if(this.isDevTesting(dev)) {
			var gm = new GlideRecord('sys_user_grmember');
			gr.addQuery('group='+devGroup+'^user='+user);
			gr.query();
			if(!gr.hasNext()) {
				gr.initialize();
				gr.group = this.getFeedbackGroup(dev);
				gr.user = user;
				gr.insert();
			}
		}
	},
	
	removeTester : function(d, u, fromRL) {
		var dev = d || this.getParameter('sysparm_dev');
		var user = u || this.getParameter('sysparm_user');
		
		if(fromRL==null || fromRL==false) {
			var gr = new GlideRecord('x_417679_devtrack_testers');
			gr.addQuery('development='+dev+'^user='+user);
			gr.query();
			if(gr.next()) gr.deleteRecord();
		}
		
		var gm = new GlideRecord('sys_user_grmember');
		gr.addQuery('group='+devGroup+'^user='+user);
		gr.query();
		if(gr.next()) gr.deleteRecord();
	},
	
	getFeedbackGroup : function(d) {
		var dev = new GlideRecord('x_417679_devtrack_development');
		if(!dev.get(d)) throw '[devTrackServer.getFeedbackGroup] couldnt find development '+d;
		
		if(dev.feedback_group!=null && dev.feedback_group!='') return dev.getValue('feedback_group');
		else {
			var name = gs.getProperty('x_417679_devtrack.group_name_format');
			name.match(/\$[a-z0-9_]+/gi).forEach(function(field, i){
				name = name.replace(field,dev[field.substring(1)]);
			});
			
			var g = new GlideRecord('x_417679_devtrack_user_group');
			g.initialize();
			g.name = name;
			g.parent = '8fe86d9607fcd010d318fd1e7c1ed002';
			g.type = 'fc27ad1607fcd010d318fd1e7c1ed000';
			var group = g.insert();
			dev.feedback_group = group;
			dev.update();
			return group;
		}
	},
	
	getRelatedTaskTables : function() {
		return Object.keys(this.getTaskTablesPropertyObject()).toString();
	},
	
	getTaskTablesPropertyObject : function() {
		var prop = gs.getProperty('x_417679_devtrack.related_task_tables');
		prop = prop.replace(/'/g,'"');
		prop = prop.replace(/ /g,'');
		return JSON.parse("{"+prop+"}");
	},
	
	getRecordLink : function(t,r) { //server and client
		var table = t || this.getParameter('sysparm_table');
		var record = r || this.getParameter('sysparm_record');
		
		var print = '<a href="$link" target="_blank" rel="noopener">$Number</a>';
		
		var gr = new GlideRecord(table);
		if(gr.get(record)) {
			print = print.replace('$Number', gr.getDisplayValue());
			print = print.replace('$link', gr.getTableName()+".do?sys_id="+gr.sys_id);
			return print;
		}
		return '';
	},
	
	getRaisedInfo : function(r) { //server and client
		var record = r || this.getParameter('sysparm_record');
		var result = {raised_by:'', raised_on:''};
		
		var gr = this.getExtGR('task', record);
		if(gr!=null) {
			result.raised_on = gr.getValue('sys_created_on');
			var field = this.getTaskTablesPropertyObject()[gr.getRecordClassName()];
			result.raised_by = gr.getValue(field!=null ? field : 'sys_opened_by');
			return record==r ? result : JSON.stringify(result);
		}
		
	},
	
	getExtGR : function(bt, r) {
		var base = new GlideRecord(bt);
		if(base.get(r)) {
			var klass = base.getRecordClassName();
			if(klass!=bt) {
				var g2 = new GlideRecord(klass);
				if(g2.get(r)) return g2;
				else throw '[devTrackServer.getExtGR] couldnt find record on extended '+klass;
			} return base;
		} else throw '[devTrackServer.getExtGR] couldnt find record on base '+bt;
	},
	
	checkNextNumber : function(table,number) { //server only
		var gr = new GlideRecord(table);
		gr.addQuery('number='+number);
		gr.query();
		if(gr.hasNext()) return this.getNextNumber(table);
		else return this.checkNumberConformity(table,number);
	},
	
	getNextNumber : function(t) { //server or client
		var table = t || this.getParameter('sysparm_table');
		var gr = new GlideRecord(table);
		gr.orderByDesc('number');
		gr.query();
		var n = '1';
		if(gr.next())
			n = (parseFloat(gr.getValue('number').replace(/[^0-9]*/,''))+1).toString(); //get number only and add 1
		
		return this.checkNumberConformity(table, n);
	},
	
	checkNumberConformity : function(table,number){ //server only
		var pre = new GlideRecord('sys_number');
		pre.addQuery('category.name='+table);
		pre.query();
		if(pre.next()) {
			var n = number.toString().replace(/[^0-9]*/,''); //
			for(i=n.length;i<pre.maximum_digits;i++) n = '0'+n;
			return pre.prefix+n;
		} else throw 'Unable to check number conformity for table '+table+' and number '+number;
		
	},
	
	// <report_field_name>: { table:<table name>, fields:<[array of fields to collate]>, format:"<how to print the fields>" }
	reportFields : {
		update_sets:{table:'sys_remote_update_set', fields:['name','commit_date'], format:"<name> (Committed On: <commit_date>)"}
	},
	
	/*
	@param current = GlideRecord of record to update.
	*/
	updateReportFields : function(current) { //server only
		var tables = this.getM2MTables(current.sys_class_name);
		var tableRecords = this.getM2MRecords(tables, current.sys_id);
		
		for(var rField in this.reportFields) { //for each report field
			current[rField] = ''; //reset current record field value
			for(var record in tableRecords[this.reportFields[rField].table]) { //for each related record in table
				var print = this.reportFields[rField].format; //set format
				for(var i=0;i<this.reportFields[rField].fields.length;i++) {
					//insert related record field value into format
					var field2find = "<"+this.reportFields[rField].fields[i]+">";
					var fieldval =  tableRecords[this.reportFields[rField].table][record][this.reportFields[rField].fields[i]];
					print = print.replace(field2find, fieldval!=''&&fieldval!=null? fieldval: '<empty>'); 
				}
				current[rField] += print+"\n";
			}
		}
		return current;
	},
	
	/*
	@param tables = object of sys_m2m objects.
	@return object of tables of records. {table1:[record1:GlideRecord, record2:GlideRecord]}
	*/
	getM2MRecords : function(tables, from_record) { //server only
		var results = {};
		for(var t in tables) {
			var records = {};
			var gr = new GlideRecord(t);
			gr.addQuery(tables[t].m2m_from_field+'='+from_record);
			gr.query();
			while(gr.next()) {
				var gr2 = new GlideRecord(tables[t].to_table);
				if(gr2.get(gr.getValue(tables[t].m2m_to_field))) records[gr.getValue('sys_id')] = gr2;
			}
			results[tables[t].to_table] = records;
		}
		return results;
	},
	
	/*
	@param table = string table name or (object of (sys_m2m objects or strings) ).
	@return GlideRecord of main relationship.
	*/
	getMainM2M : function(tables) { //server only
		var result = {};
		if(typeof tables == 'object') {
			for(var t in tables) result[t] = get(t);
		} else if(typeof tables == 'string') return get(tables);
			
		function get(table) {
			var gr = new GlideRecord(table);
			gr.addQuery('main_rel=true');
			gr.query();
			if(gr.next()) return gr;
			else return null;
		}
	},
	
	/*
	@param tables = object of sys_m2m objects. add main_table = true to main table object were main rel is.
	@param from = string sys_id of from record (usually current.sys_id).
	@param to = string sys_id of main record to create relationship for.
	
	@return array of action objects taken for what records. [{action:insert_add, record:sys_id, table:tablename}]
	*/
	updateMainM2M : function(tables, from, to) { //server only
		var actions = [];
		for(var table in tables) {
			var gr = new GlideRecord(table);

			//create new main relationship if it is correct table
			if(tables[table].main_table==true) { 
				gr.addQuery(tables[table].m2m_from_field+'='+from+'^'+tables[table].m2m_to_field+'='+to);
				gr.query();
				if(gr.next()) {
					gr.main_rel = true;
					actions.push({action:'update_add', record: gr.update(), table:table});
				} else {
					gr.initialize();
					gr[tables[table].m2m_from_field] = from;
					gr[tables[table].m2m_to_field] = to;
					gr.main_rel = true;
					actions.push({action:'insert_add', record: gr.insert(), table:table});
				}
				gr = new GlideRecord(table); //clear previous query
			}
			//clear other main rels
			gr.addQuery(tables[table].m2m_from_field+'='+from+'^main_rel=true'
						+(tables[table].main_table==true ? '^'+tables[table].m2m_to_field+'!='+to : ''));
			gr.query();
			while(gr.next()) {
				gr.setValue('main_rel', false);
				actions.push({action:'update_remove', record: gr.update(), table:table});
			}
		}
		return actions;
	},
	
	//list of related record tables
	relatedRecordM2Ms : 'incident,sc_req_item,change_request,problem,rm_defect',
	
	/*
	@param from_table = string name of from table.
	@param to_table = string name of to table or NULL.
	@param extraCondition = extra condition added to query or NULL.
	@param mainTable = (Conditional) if no to_table specified, specify a mainTable which holds the main relationship.
	
	@return object of sys_m2m objects.
	*/
	getM2MTables : function(from_table, to_table, extraCondition, mainTable) { //server only
		var includedFields = ['m2m_table','from_table','m2m_from_field','to_table','m2m_to_field'];
		var tables = {};
		var gr = new GlideRecord('sys_m2m');
		gr.addQuery('from_table='+from_table
					+(to_table!=null ? '^to_table='+to_table : '')
					+(extraCondition!=null ? '^'+extraCondition : ''));
		gr.query();
		while(gr.next()) {
			var t = gr.getValue('m2m_table');
			tables[t] = {};
			includedFields.forEach(function(f,i){
				tables[t][f] = gr.getValue(f);
			});
			tables[t].main_table = (tables[t].to_table==to_table||(tables[t].to_table==mainTable) ? true : false);
		}
		return tables;
	},

    type: 'devTrackServer'
});]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>Aidan.Lovegrove</sys_created_by>
        <sys_created_on>2020-05-14 21:59:12</sys_created_on>
        <sys_id>d3045e1507b01010d318fd1e7c1ed08f</sys_id>
        <sys_mod_count>75</sys_mod_count>
        <sys_name>devTrackServer</sys_name>
        <sys_package display_value="Development Tracker" source="x_417679_devtrack">24eff4c907745010d318fd1e7c1ed0fe</sys_package>
        <sys_policy/>
        <sys_scope display_value="Development Tracker">24eff4c907745010d318fd1e7c1ed0fe</sys_scope>
        <sys_update_name>sys_script_include_d3045e1507b01010d318fd1e7c1ed08f</sys_update_name>
        <sys_updated_by>Aidan.Lovegrove</sys_updated_by>
        <sys_updated_on>2020-05-19 22:07:59</sys_updated_on>
    </sys_script_include>
</record_update>
